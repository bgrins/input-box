<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiptap Bundle Example</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      #editor {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        min-height: 200px;
        padding: 16px;
      }
      .ProseMirror {
        outline: none;
      }
      .ProseMirror p.is-editor-empty:first-child::before {
        color: #adb5bd;
        content: attr(data-placeholder);
        float: left;
        height: 0;
        pointer-events: none;
      }
      .ProseMirror-focused {
        border-color: #4c6ef5;
      }
      h1 {
        color: #333;
      }
      .controls {
        margin-bottom: 10px;
      }
      button {
        margin-right: 8px;
        padding: 8px 12px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #e0e0e0;
      }
      button.is-active {
        background: #4c6ef5;
        color: white;
      }
      .mention {
        background-color: #dee2e6;
        border-radius: 0.25rem;
        color: #495057;
        padding: 0.1rem 0.3rem;
      }
      .suggestion-list {
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        padding: 4px;
      }
      .suggestion-item {
        padding: 8px;
        cursor: pointer;
        border-radius: 4px;
      }
      .suggestion-item.is-selected {
        background: #4c6ef5;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Tiptap Editor - Standalone ESM Bundle</h1>

    <div class="controls">
      <button onclick="toggleBold()">Bold</button>
      <button onclick="toggleItalic()">Italic</button>
      <button onclick="toggleStrike()">Strike</button>
      <button onclick="toggleCode()">Code</button>
      <button onclick="addLink()">Add Link</button>
    </div>

    <div id="editor"></div>

    <p>Content: <span id="content-display"></span></p>

    <script type="module">
      import {
        Editor,
        StarterKit,
        Placeholder,
        Mention,
        floatingUI,
      } from "./dist-tiptap/tiptap-bundle.js";

      // Sample mention items
      const mentionItems = [
        { id: "1", label: "Alice Johnson" },
        { id: "2", label: "Bob Smith" },
        { id: "3", label: "Charlie Brown" },
        { id: "4", label: "Diana Prince" },
        { id: "5", label: "Eve Martinez" },
      ];

      // Simple dropdown component for managing mention suggestions
      class MentionDropdown {
        constructor() {
          this.element = null;
          this.items = [];
          this.selectedIndex = 0;
          this.onSelectCallback = null;
        }

        create(items, onSelect) {
          this.items = items;
          this.selectedIndex = 0;
          this.onSelectCallback = onSelect;

          this.element = document.createElement("div");
          this.element.className = "suggestion-list";
          this.render();

          this.element.addEventListener("click", (e) => {
            const item = e.target.closest(".suggestion-item");
            if (item) {
              const index = parseInt(item.dataset.index);
              this.selectItem(index);
            }
          });

          document.body.appendChild(this.element);
          return this.element;
        }

        render() {
          if (!this.element) return;

          this.element.innerHTML = "";
          this.items.forEach((item, index) => {
            const div = document.createElement("div");
            div.className = "suggestion-item";
            if (index === this.selectedIndex) {
              div.classList.add("is-selected");
            }
            div.textContent = item.label;
            div.dataset.index = index;
            this.element.appendChild(div);
          });
        }

        update(items) {
          this.items = items;
          this.selectedIndex = Math.min(this.selectedIndex, items.length - 1);
          this.render();
        }

        updatePosition(rect) {
          if (!this.element) return;

          const virtualEl = {
            getBoundingClientRect: () => rect,
          };

          floatingUI
            .computePosition(virtualEl, this.element, {
              placement: "bottom-start",
            })
            .then(({ x, y }) => {
              Object.assign(this.element.style, {
                position: "absolute",
                left: `${x}px`,
                top: `${y}px`,
              });
            });
        }

        selectNext() {
          this.selectedIndex = (this.selectedIndex + 1) % this.items.length;
          this.render();
          this.scrollToSelected();
        }

        selectPrevious() {
          this.selectedIndex =
            (this.selectedIndex - 1 + this.items.length) % this.items.length;
          this.render();
          this.scrollToSelected();
        }

        selectItem(index = this.selectedIndex) {
          if (index >= 0 && index < this.items.length) {
            this.onSelectCallback?.(this.items[index]);
          }
        }

        scrollToSelected() {
          const selected = this.element?.querySelector(".is-selected");
          if (selected) {
            selected.scrollIntoView({
              block: "nearest",
              behavior: "smooth",
            });
          }
        }

        handleKeyDown(event) {
          if (event.key === "ArrowUp") {
            event.preventDefault();
            this.selectPrevious();
            return true;
          }

          if (event.key === "ArrowDown") {
            event.preventDefault();
            this.selectNext();
            return true;
          }

          if (event.key === "Enter") {
            event.preventDefault();
            this.selectItem();
            return true;
          }

          return false;
        }

        destroy() {
          this.element?.remove();
          this.element = null;
        }
      }

      // Create editor instance
      const editor = new Editor({
        element: document.querySelector("#editor"),
        extensions: [
          StarterKit,
          Placeholder.configure({
            placeholder: "Start typing... Type @ to mention someone",
          }),
          Mention.configure({
            HTMLAttributes: {
              class: "mention",
            },
            suggestion: {
              items: ({ query }) => {
                return mentionItems
                  .filter((item) =>
                    item.label.toLowerCase().includes(query.toLowerCase()),
                  )
                  .slice(0, 5);
              },
              render: () => {
                let dropdown;

                return {
                  onStart: (props) => {
                    dropdown = new MentionDropdown();
                    dropdown.create(props.items, (item) => {
                      props.command(item);
                    });
                    dropdown.updatePosition(props.clientRect());
                  },

                  onUpdate(props) {
                    dropdown?.update(props.items);
                    dropdown?.updatePosition(props.clientRect());
                  },

                  onKeyDown(props) {
                    return dropdown?.handleKeyDown(props.event) || false;
                  },

                  onExit() {
                    dropdown?.destroy();
                  },
                };
              },
            },
          }),
        ],
        content:
          "<p>Hello! This is a Tiptap editor loaded from a standalone ESM bundle without npm! Type @ to mention someone.</p>",
        onUpdate: ({ editor }) => {
          document.getElementById("content-display").textContent =
            editor.getHTML();
        },
      });

      // Make editor available globally for the button functions
      window.editor = editor;

      // Button functions
      window.toggleBold = () => editor.chain().focus().toggleBold().run();
      window.toggleItalic = () => editor.chain().focus().toggleItalic().run();
      window.toggleStrike = () => editor.chain().focus().toggleStrike().run();
      window.toggleCode = () => editor.chain().focus().toggleCode().run();
      window.addLink = () => {
        const url = prompt("Enter URL:");
        if (url) {
          editor.chain().focus().setLink({ href: url }).run();
        }
      };
    </script>
  </body>
</html>
